#===============================================================================
#
#                         OOOO
#                       OOOOOOOO
#      PPPPPPPPPPPPP   OOO    OOO   PPPPPPPPPPPPP
#    PPPPPPPPPPPPPP   OOO      OOO   PPPPPPPPPPPPPP
#   PPP         PPP   OOO      OOO   PPP         PPP
#  PPP          PPP   OOO      OOO   PPP          PPP
#  PPP          PPP   OOO      OOO   PPP          PPP
#  PPP          PPP   OOO      OOO   PPP          PPP
#   PPP         PPP   OOO      OOO   PPP         PPP
#    PPPPPPPPPPPPPP   OOO      OOO   PPPPPPPPPPPPPP
#     PPPPPPPPPPPPP   OOO      OOO   PPP
#               PPP   OOO      OOO   PPP
#               PPP   OOO      OOO   PPP
#               PPP   OOO      OOO   PPP
#               PPP    OOO    OOO    PPP
#               PPP     OOOOOOOO     PPP
#              PPPPP      OOOO      PPPPP
#
# @file:   ss3rules.txt
# @author: Hugh Spahr
# @date:   2/8/2015
#
# @note:   Open Pinball Project
#          Copyright© 2015, Hugh Spahr
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#===============================================================================
#
# This is a rules file for the Sharp Shooter 3 pinball machine.
#
#===============================================================================

SOLENOID_CARDS       2
{
   #Name                      Card  I/O   Flags       InitKick    DutyCycle   MinOff	Desc
   Sol_Upper_Lft_Pop          1     1     USE_SWITCH      48         0        0			"UpLftPop"
   Sol_Upper_Ctr_Pop          1     2     USE_SWITCH      48         0        0			"UpCtrPop"
   Sol_Top_Drop_Rubber        1     4     USE_SWITCH       0         0        0			"TopDropRbr"
   Sol_Drop_Bank              1     5     USE_SWITCH      48         0        0			"DropBank"
   Sol_Kickout_Hole           1     8     AUTO_CLR        48         0        0			"KickOut"
   
   Sol_Btm_Lft_Sling          2     1     USE_SWITCH      48         0        0			"BtmLftSling"
   Sol_Lft_Flipper            2     2     USE_SWITCH      48         4        0			"LftFlip"
   Sol_Ball_In_Play           2     4     AUTO_CLR        48         0        0			"BallInPlay"
   Sol_Rght_Flipper           2     5     USE_SWITCH      48         4        0			"RghtFlip"
   Sol_Btm_Low_Pop            2     7     USE_SWITCH      48         0        0			"BtmLowPop"
   Sol_Btm_Up_Pop             2     8     USE_SWITCH      48         0        0			"BtmUpPop"
}

INPUT_CARDS          2
{
   #Name                      Card  I/O   Type				Desc
   Inp_Spinner                1     1     FALL_EDGE			"Spinner"			
   Inp_Ctr_Rght_Rubber        1     2     FALL_EDGE			"CtrRghtRbr"
   Inp_Horshoe_Rollover       1     3     FALL_EDGE			"HorseRoll"
   Inp_Below_Kickout_Rollover 1     4     FALL_EDGE			"BlwKickRoll"
   Inp_Upper_Rubber           1     5     FALL_EDGE			"UpRbr"
   Inp_Upper_Rght_Rollover    1     6     FALL_EDGE			"UpRghtRoll"
   Inp_Upper_Ctr_Rollover     1     7     FALL_EDGE			"UpCtrRoll"
   Inp_Upper_Lft_Rollover     1     8     FALL_EDGE			"UpLftRoll"
   Inp_Upper_Lft_Top_Trgt     1     11    FALL_EDGE	    	"UpLftTopTrgt"
   Inp_Upper_Lft_Btm_Trgt     1     12    FALL_EDGE			"UpLftBtmTrgt"
   Inp_Ctr_Rght_Rollover      1     14    FALL_EDGE			"CtrRghtRoll"
   Inp_Ctr_Ctr_Rollover       1     15    FALL_EDGE			"CtrCtrRoll"
   Inp_Ctr_Lft_Rollover       1     16    FALL_EDGE			"CtrLftRoll"
   
   Inp_Btm_Lft_InLn_Rollover  2     1     FALL_EDGE			"BtmLftInLnRoll"
   Inp_Btm_Lft_OutLn_Rollover 2     2     FALL_EDGE			"BtmLftOutLnRoll"
   Inp_Ctr_Low_Rollover       2     3     FALL_EDGE			"CtrLowRoll"
   Inp_Drop_Bank_Miss         2     4     FALL_EDGE			"DropBnkMiss"
   Inp_Btm_Rght_Rubber        2     5     FALL_EDGE			"BtmRghtRbr"
   Inp_Btm_Rght_Low_Rubber    2     6     FALL_EDGE			"BtmRghtLowRbr"
   Inp_Slam_Tilt              2     7     FALL_EDGE			"SlamTilt"
   Inp_Start                  2     8     FALL_EDGE			"Start"
   Inp_Coin_Drop              2     9     FALL_EDGE			"CoinDrp"
   Inp_Drop_Trgt_1S           2    10     FALL_EDGE			"DrpTrgt1S"
   Inp_Drop_Trgt_2H           2    11     FALL_EDGE			"DrpTrgt2H"
   Inp_Drop_Trgt_3O           2    12     FALL_EDGE			"DrpTrgt3O"
   Inp_Drop_Trgt_4O           2    13     FALL_EDGE			"DrpTrgt4O"
   Inp_Drop_Trgt_5T           2    14     FALL_EDGE			"DrpTrgt5T"
   Inp_Drop_Trgt_6E           2    15     FALL_EDGE			"DrpTrgt6E"
   Inp_Drop_Trgt_7R           2    16     FALL_EDGE			"DrpTrgt7R"
}

LED_CARDS            6
{
   #Name                      Card  I/O		Desc
   Led_Spinner                1     1		"Spinner"
   Led_Horseshoe              1     2		"Horseshoe"
   Led_KO_Top_Lft             1     3		"KOTopLft"
   Led_KO_Top_Rght            1     4		"KOTopRght"
   Led_KO_Ctr_Lft             1     5		"KOCtrLft"
   Led_KO_Ctr_Rght            1     6		"KOCtrRght"
   Led_KO_Ctr_Ctr             1     7		"KOCtrCtr"
   Led_KO_Ctr_Btm             1     8		"KOCtrBtm"
   
   Led_Inln_Rght              2     1		"InlnRght"
   Led_Inln_Ctr               2     2		"InlnCtr"
   Led_Inln_Lft               2     3		"InlnLft"
   Led_Roll_Rght              2     6		"RollRght"
   Led_Roll_Ctr               2     7		"RollCtr"
   Led_Roll_Lft               2     8		"RollLft"

   Led_Mode_11                3     4		"Mode11"
   Led_Mode_10                3     5		"Mode10"
   Led_Mode_9                 3     6		"Mode9"
   Led_Mode_8                 3     7		"Mode8"
   Led_Mode_7                 3     8		"Mode7"

   Led_Shoot_Again            4     1		"ShootAgain"
   Led_Mult_4                 4     5		"Mult4"
   Led_Mult_3                 4     6		"Mult3"
   Led_Mult_2                 4     7		"Mult2"
   Led_Mult_1                 4     8		"Mult1"
   
   Led_Lft_Outln              5     1		"LftOutln"
   Led_Lft_Inln               5     2		"LftInln"
   Led_Mode_1                 5     3		"Mode1"
   Led_Mode_2                 5     4		"Mode2"
   Led_Mode_3                 5     5		"Mode3"
   Led_Mode_4                 5     6		"Mode4"
   Led_Mode_5                 5     7		"Mode5"
   Led_Mode_6                 5     8		"Mode6"

   Led_DT_7                   6     2		"DT7"              # Drop targets 1 (left) 7 (right)
   Led_DT_6                   6     3		"DT6"
   Led_DT_5                   6     4		"DT5"
   Led_DT_4                   6     5		"DT4"
   Led_DT_3                   6     6		"DT3"
   Led_DT_2                   6     7		"DT2"
   Led_DT_1                   6     8		"DT1"
}

VARIABLES
{
   #Name                      InitVal
   Var_credits                0
   Var_partCreditsNum         0
   Var_partCreditsDenom       2
   Var_creditsInRow           0
   Var_extraCredit            4
   Var_numPlayers             0
   Var_maxPlayers             4
   Var_currPlayer             0
   Var_ballNum                0
   Var_ballsPerGame           3
   Var_highScore              10000
   Var_targets                0
   Var_kick_retries           0
   Var_prev_flipper           0
   Var_tilted                 0
}

INDEXED_VARIABLES
{
   #Name                      NumEntries  InitVals
   IndVar_score               4           {0  0  0  0}
   IndVar_InlaneLights        4           {0  0  0  0}
   IndVar_scoreLvl            4           {0  0  0  0}
   IndVar_specialLvl          4           {0  0  0  0}
}

SOUND_CLIPS
{
   #Name                   Location
   Sound_HowdyFolks        "sounds/howdyFolks.wav"
   Sound_Ding_Ding         "sounds/ding_ding.wav"
   Sound_Wah_Wuh           "sounds/wah_wuh.wav"
}

BGND_CLIPS
{
   #Name                   Location
   Sound_BgndTrack         "sounds/bgndtrack.mp3"
}

IMAGES
{
   #Name                   Location
   Image_Saloon            "graphics/sal_empty.jpg"   		MAIN_SCR
   Image_Saloon_Girl       "graphics/sal_girl.jpg"   		MAIN_SCR
   Image_Saloon_Guy        "graphics/sal_guy.jpg"   		MAIN_SCR
   Image_Guy_Hit           "graphics/sal_guyShot.jpg"   	MAIN_SCR
   Image_Guy_Shooting      "graphics/sal_guyBang.jpg"   	MAIN_SCR
}

TICK_TIME                  20                            # 20 ms tick timer

TIMERS
{
   #Name                   NumMs
   Timeout_Kickout_Timer   1000                          # 1 second
   Timeout_Ball_Locate     5000                          # 5 seconds
   Timeout_Special_Timer   30000                         # 30 seconds
}

PROCESS_CHAINS
{
   #Name                   Processing
   Proc_Tilt               { if (Inp_Tilt_Switch)
                              {(DISABLE_SOLENOIDS) (MODE = Mode_Tilt)}
                           }
   
   Proc_Flipper            {if (Sol_Left_Flipper && ((Var_prev_flipper & SOL_LEFT_FLIPPER) == 0))
                              (LED_ROT_LEFT, (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right),
                              IndVar_InlaneLights[Var_currPlayer])
                           if (Sol_Right_Flipper && ((Var_prev_flipper & SOL_RIGHT_FLIPPER) == 0))
                              (LED_ROT_RIGHT, (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right),
                              IndVar_InlaneLights[Var_currPlayer])
                           (Var_prev_flipper = (Sol_Left_Flipper | Sol_Right_Flipper))}
   
   Proc_Inlane             {if (Inp_Inlane_Left && ((IndVar_InlaneLights[Var_currPlayer] & Led_Inlane_Left) == 0))
                              {(IndVar_InlaneLights[Var_currPlayer] |= Led_Inlane_Left)
                              (LED_ON, Led_Inlane_Left)}
                           if (Inp_Inlane_Center && ((IndVar_InlaneLights[Var_currPlayer] & Led_Inlane_Center) == 0))
                              {(IndVar_InlaneLights[Var_currPlayer] |= Led_Inlane_Center)
                              (LED_ON, Led_Inlane_Center)}
                           if (Inp_Inlane_Right && ((IndVar_InlaneLights[Var_currPlayer] & Led_Inlane_Right) == 0))
                              {(IndVar_InlaneLights[Var_currPlayer] |= Led_Inlane_Right)
                              (LED_ON, Led_Inlane_Right)}
                           if ((IndVar_InlaneLights[Var_currPlayer] & (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right)) ==
                              (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right))
                              (MODE = Mode_Inlane_Complete)}
   
   Proc_Targets            {if (Inp_Left_Target1)
                              {(LED_ON, Led_Left_Target1) (Var_targets |= Led_Left_Target1)}
                           if (Inp_Left_Target2)
                              {(LED_ON, Led_Left_Target2) (Var_targets |= Led_Left_Target2)}
                           if (Inp_Right_Target1)
                              {(LED_ON, Led_Right_Target1) (Var_targets |= Led_Right_Target1)}
                           if (Inp_Right_Target2)
                              {(LED_ON, Led_Right_Target2) (Var_targets |= Led_Right_Target2)}
                           if ((Var_targets & (Led_Left_Target1 | Led_Left_Target2 | Led_Right_Target1 | Led_Right_Target2)) ==
                              (Led_Left_Target1 | Led_Left_Target2 | Led_Right_Target1 | Led_Right_Target2))
                              (MODE = Mode_Targets_Complete)}
   
   Proc_Kickout_Hole       {if (Sol_Kickout_Hole)
                              (KICK Sol_Kickout_Hole)}
   Proc_Ball_Drain         {if (Sol_Ball_In_Play)
                              (MODE = Mode_End_Of_Ball)}
                              
   Proc_Tilt_Init          {(Var_tilted = 1)
                           if (Sol_Kickout_Hole)
                              {(KICK Sol_Kickout_Hole) (Var_kick_retries = 0) (START Timeout_Kickout_Timer)}
                           (START Timeout_Ball_Locate)}
   
   Proc_Tilt_State         {if (Sol_Ball_In_Play)
                              {(ENABLE_SOLENOIDS) (MODE = Mode_End_Of_Ball)}
                           if (EXPIRED Timeout_Kickout_Timer)
                              {if (Sol_Kickout_Hole)
                                 {(Var_kick_retries++)
                                 if (Var_kick_retries > 5)
                                    {(MODE = Mode_Error) (TEXT = "Can't clear kickout hole")}
                                 (START Timeout_Kickout_Timer) (KICK Sol_Kickout_Hole)}}
                           if (EXPIRED Timeout_Ball_Locate)
                              {(MODE = Mode_Error) (TEXT = "Lost Ball")}}
   
   Proc_Init               {(DISABLE_SOLENOIDS)
                           if (Var_credits == 0)
                              (MODE = Mode_Attract)
                           else
                              (MODE = Mode_Press_Start)}
   
   Proc_Add_Coin           {if (Inp_Coin_Drop) 
                              {(Var_creditsInRow++) (Var_partCreditsNum++)
                              if (Var_creditsInRow == Var_extraCredit)
                                 {(Var_credits++) (Var_creditsInRow = 0)}
                              if (Var_partCreditsNum == Var_partCreditsDenom)
                                 {(Var_credits++) (Var_partCreditsNum = 0)}}
                           if (Inp_Start_Button)
                              (Var_creditsInRow = 0)}
   
   Proc_Press_Start        {if (Inp_Start_Button && Var_credits && (Var_ballNum == 0))
                              {if (Var_numPlayers < Var_maxPlayers)
                                 {(Var_credits--) (Var_numPlayers++)}}
                           if (MODE == Mode_Press_Start)
                              (MODE = Mode_Start_Game)}
   
   Proc_Start_and_Coin     {Proc_Add_Coin, Proc_Press_Start}
   
   Proc_Init_Game          {(IndVar_score = 0) (IndVar_InlaneLights = 0)
                              (Var_ballNum = 0) (IndVar_scoreLvl = 0)
                              (IndVar_specialLvl = 0)(ENABLE_SOLENOIDS)}
   
   Proc_Start_Game         {if (Inp_Ball_At_Plunger || Sol_Kickout_Hole)
                              (MODE = Mode_Ball_In_Play)
                            else if (Sol_Ball_In_Play)
                              (MODE = Mode_Start_Ball)
                            else
                              {(MODE = Mode_Error) (TEXT = "Can't find ball")}}
   
   Proc_Start_Ball_Init    {(START Timeout_Kickout_Timer) (KICK Sol_Ball_In_Play) (Var_kick_retries = 0)}
   
   Proc_Start_Ball_Start   {if (Inp_Ball_At_Plunger)
                              (MODE = Mode_Ball_In_Play)
                           if (EXPIRED Timeout_Kickout_Timer)
                              {(Var_kick_retries++)
                              if (Var_kick_retries > 5)
                                 {(MODE = Mode_Error) (TEXT = "Ball kick failed!")}
                              (START Timeout_Kickout_Timer) (KICK Sol_Ball_In_Play)}}
                              
   Proc_Ball_In_Play_Init  {(LED_BLINK_100, Led_Inlane_Center) (LED_OFF, (Led_Inlane_Left |
                              Led_Inlane_Right | Led_Left_Target1 | Led_Left_Target2 |
                              Led_Right_Target1 | Led_Right_Target2 | Led_Special))
                              (Var_prev_flipper = 0) (Var_targets = 0) (Var_tilted = 0)}
   
   Proc_Ball_In_Play_Start {if (Inp_Inlane_Left || Inp_Inlane_Right)
                              (MODE = Mode_Normal_Play)
                           if (Inp_Inlane_Center)
                              {(SOUND Sound_Ding_Ding) (TEXT = "Skill Shot")
                              (IndVar_score[Var_currPlayer] += 1000) (MODE = Mode_Normal_Play)}}
   
   Proc_Normal_Play_Init   {(LED_SET, (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right), IndVar_InlaneLights[Var_currPlayer])}
   
   Proc_Normal_Play        {Proc_Tilt, Proc_Flipper, Proc_Inlane, Proc_Targets, Proc_Kickout_Hole,
                              Proc_Start_and_Coin, Proc_Ball_Drain}
   
   Proc_End_Of_Ball        {if (Var_tilted == 0)
                              {(TEXT = "Bonus %d", (IndVar_scoreLvl[Var_currPlayer] * 1000))
                              (IndVar_score[Var_currPlayer] += (IndVar_scoreLvl[Var_currPlayer] * 1000))
                              (WAIT 3000)}
                           (Var_currPlayer++)
                           if (Var_currPlayer >= Var_numPlayers)
                              {(Var_currPlayer = 0) (Var_ballNum++)
                              if (Var_ballNum >= Var_ballsPerGame)
                                 {(TEXT = "Game Over")(WAIT 3000)
                                 if (Var_credits == 0)
                                    (MODE = Mode_Attract)
                                 else
                                    (MODE = Mode_Press_Start)}
                              else
                                 {(TEXT = "Player %d, Ball %d", (Var_currPlayer + 1), (Var_ballNum + 1))
                                 (MODE = Mode_Start_Ball)}}
                           else
                              {(TEXT = "Player %d, Ball %d", (Var_currPlayer + 1), (Var_ballNum + 1))
                              (MODE = Mode_Start_Ball)}}
   
   Proc_Inlane_Comp        {(TEXT = "Inlanes Complete!!")(IndVar_scoreLvl[Var_currPlayer]++)
                           (IndVar_score[Var_currPlayer] += 1000)
                           (IndVar_InlaneLights[Var_currPlayer] = 0)
                           (LED_OFF, (Led_Inlane_Left | Led_Inlane_Center | Led_Inlane_Right))
                           (MODE = Mode_Normal_Play)}
   
   Proc_Targets_Comp_Init  {(LED_BLINK_100, Led_Special)(TEXT = "Super Mode!")
                           (IndVar_specialLvl[Var_currPlayer]++)
                           (IndVar_score[Var_currPlayer] += (IndVar_specialLvl[Var_currPlayer] * 1000))
                           (START Timeout_Special_Timer)}
   
   Proc_Targets_Comp_State {if (Sol_Kickout_Hole)
                              {(TEXT = "Jackpot")(VIDEO Video_Defcon19)
                              (IndVar_score[Var_currPlayer] += (IndVar_specialLvl[Var_currPlayer] * 1000))}
                           if (EXPIRED Timeout_Special_Timer)
                              (MODE = Mode_Normal_Play)
                           (Proc_Normal_Play)}
}

LED_CHAINS
{
   #Name                   Processing (Mask, bits, cmd, bits, cmd, ...)
   LedCh_Attract           {(Led_DT_1 | Led_DT_2 | Led_DT_3 | Led_DT_4 | Led_DT_5 | Led_DT_6 | Led_DT_7),
                              Led_DT_1, WAIT 100, Led_DT_2, WAIT 100, Led_DT_3, WAIT 100, Led_DT_4, WAIT 100,
                              Led_DT_5, WAIT 100, Led_DT_6, WAIT 100, Led_DT_7, REPEAT}
   
   LedCh_Tilt              {(Led_Shoot_Again), 0, END_CHAIN}
}

SOUND_CHAINS
{
   #Name                   Processing (sound, cmd, sound, cmd, ...)
   SndCh_Start             { Sound_HowdyFolks, WAIT 5000, REPEAT}
}

IMAGE_CHAINS
{
   #Name                   Processing (image, cmd, image, cmd, ...)
   ImageCh_Attract         { Image_Saloon, WAIT 1000, Image_Saloon_Girl, WAIT 1000,
                             Image_Saloon, WAIT 1000, Image_Saloon_Guy, WAIT 1000, Image_Guy_Shooting, WAIT 1000,
                             Image_Saloon, WAIT 1000, Image_Saloon_Guy, WAIT 1000, Image_Guy_Hit, WAIT 1000,
                             REPEAT}
}

MODES
{
   #Name                   Desc			InitChain                  ProcessChain                                       VideoChain
   #                                      		AudioChain                                  LedChain                                       InitScoringNum
   Mode_Init               "Init"		{(Proc_Init)               ()                                                 ()
                                          		()                                          ()                                             ()}
   Mode_Attract            "Attract"	{()                        (Proc_Init, Proc_Add_Coin)                         (ImageCh_Attract)
                                          		()                                          (LedCh_Attract)                                ()}
   Mode_Press_Start        "PrssStrt"	{(Proc_Press_Start_Init)   (Proc_Start_and_Coin)                              ()
                                          		(SndCh_Start)                               (LedCh_Attract)                                ()}
   Mode_Start_Game         "StrtGame"	{(Proc_Init_Game)          (Proc_Start_Game, Proc_Start_and_Coin)             ()                        
                                          		()                                          ()                                             ()}
   Mode_Start_Ball         "StrtBall"	{(Proc_Start_Ball_Init)    (Proc_Start_Ball_Start, Proc_Start_and_Coin)       ()
                                          		()                                          ()                                             ()}
   Mode_Ball_In_Play       "BallInPlay"	{(Proc_Ball_In_Play_Init)  (Proc_Ball_In_Play_Start, Proc_Start_and_Coin)     ()
                                          		()                                          ()                                             ()}
   Mode_Normal_Play        "NormalPlay"	{(Proc_Normal_Play_Init)   (Proc_Normal_Play)                                 ()
                                          		()                                          ()                                             ()}
   Mode_Error              "Error"		{()                        ()                                                 ()
                                          		()                                          ()                                             ()}
   Mode_Tilt               "Tilt"		{(Proc_Tilt_Init)          (Proc_Tilt_State)                                  ()
                                          		(Sound_Wah_Wuh)                             (LedCh_Tilt)                                   ()}
   Mode_End_Of_Ball        "EndOfBall"	{(Proc_End_Of_Ball)        ()                                                 ()
                                          		()                                          ()                                             ()}
   Mode_Inlane_Complete    "InlnComp"	{(Proc_Inlane_Comp)        ()                                                 ()
                                          		()                                          ()                                             ()}
   Mode_Targets_Complete   "TrgtComp"	{(Proc_Targets_Comp_Init)  (Proc_Targets_Comp_State)                          ()
                                          		()                                          ()                                             ()}
}

FIRST_MODE                 Mode_Init

CARD_ORDER
{
   INPUT_CARD, SOLENOID_CARD, INPUT_CARD, SOLENOID_CARD
}